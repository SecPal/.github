# SPDX-FileCopyrightText: 2025 SecPal
# SPDX-License-Identifier: CC0-1.0

name: Add Issues to Project

on:
  issues:
    types:
      - opened
      - reopened
      - labeled

jobs:
  add-to-project:
    name: Add issue to project board
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    outputs:
      project-add-outcome: ${{ steps.set-outcome.outputs.outcome }}
    steps:
      - name: Add to project
        id: add-to-project
        continue-on-error: true
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/SecPal/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set outcome output
        id: set-outcome
        if: always()
        run: echo "outcome=${{ steps.add-to-project.outcome }}" >> "$GITHUB_OUTPUT"

      - name: Comment if project add failed
        if: steps.add-to-project.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              'âš ï¸ **Manual Action Required**',
              '',
              'This issue could not be automatically added to the [SecPal Feature Roadmap](https://github.com/orgs/SecPal/projects/1) due to missing permissions.',
              '',
              '**To add manually:**',
              '```bash',
              `gh project item-add 1 --owner SecPal --url ${context.payload.issue.html_url}`,
              '```',
              '',
              '**To enable automation:** An organization admin needs to:',
              '1. Create a fine-grained Personal Access Token with `Contents: Read` and `Projects: Read & Write` permissions',
              '2. Add it as a repository secret named `PROJECT_TOKEN`',
              '3. Update this workflow to use `github-token: ${{ secrets.PROJECT_TOKEN }}`',
              '',
              'See: https://docs.github.com/en/issues/planning-and-tracking-with-projects/automating-your-project/using-the-api-to-manage-projects'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  set-status-field:
    name: Set initial status based on labels
    runs-on: ubuntu-latest
    needs: add-to-project
    permissions:
      issues: write
      contents: read
    if: |
      (success() || failure()) &&
      (contains(github.event.issue.labels.*.name, 'enhancement') || contains(github.event.issue.labels.*.name, 'core-feature'))
    steps:
      - name: Determine initial status
        id: status
        run: |
          # Check labels to determine initial project status
          CORE_FEATURE="${{ contains(github.event.issue.labels.*.name, 'core-feature') }}"
          BLOCKER="${{ contains(github.event.issue.labels.*.name, 'priority: blocker') }}"

          if [[ "$CORE_FEATURE" == "true" ]]; then
            echo "status=ðŸ“‹ Backlog" >> "$GITHUB_OUTPUT"
          elif [[ "$BLOCKER" == "true" ]]; then
            echo "status=ðŸŽ¯ Ready" >> "$GITHUB_OUTPUT"
          else
            echo "status=ðŸ’¡ Ideas" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const projectAdded = '${{ needs.add-to-project.outputs.project-add-outcome }}' === 'success';
            const message = projectAdded
              ? `âœ… This issue has been automatically added to the [SecPal Feature Roadmap](https://github.com/orgs/SecPal/projects/1) with status: **${status}**`
              : `ðŸ“‹ Suggested status for [SecPal Feature Roadmap](https://github.com/orgs/SecPal/projects/1): **${status}**`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${message}\n\nNext steps:\n- Review and refine the issue description\n- Add relevant labels (area, priority)\n- Link related issues/PRs\n- Move to appropriate project column as needed`
            });
