# SPDX-FileCopyrightText: 2025 SecPal
# SPDX-License-Identifier: CC0-1.0

name: Reusable PR Size Check

on:
  workflow_call:
    inputs:
      max-lines:
        description: "Maximum number of lines allowed in a PR"
        required: false
        type: number
        default: 600
      exclude-patterns:
        description: "Additional file patterns to exclude (comma-separated grep-compatible regex)"
        required: false
        type: string
        default: ""

jobs:
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check PR size
        env:
          GH_TOKEN: ${{ github.token }}
          MAX_LINES: ${{ inputs.max-lines }}
        run: |
          # Check if PR has 'large-pr-approved' label
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')

          if echo "$LABELS" | grep -q "large-pr-approved"; then
            echo "✅ PR has 'large-pr-approved' label - skipping size check"
            echo "Reason: Legitimate large PR (e.g., boilerplate templates, auto-generated code)"
            exit 0
          fi

          # Fetch base branch
          git fetch origin ${{ github.base_ref }}

          # Calculate merge base
          MERGE_BASE=$(git merge-base origin/${{ github.base_ref }} HEAD)

          # Get raw diff output
          RAW_DIFF_OUTPUT=$(git diff --numstat "$MERGE_BASE"..HEAD)
          DIFF_OUTPUT="$RAW_DIFF_OUTPUT"

          # Load exclude patterns from .preflight-exclude if it exists
          if [ -f ".preflight-exclude" ]; then
            # Extract non-comment, non-empty lines as grep-compatible regex patterns
            # Strip CR for Windows/CRLF compatibility
            EXCLUDE_PATTERNS=$(grep -vE '^[[:space:]]*(#|$)' ".preflight-exclude" | tr -d '\r' || true)

            if [ -n "$EXCLUDE_PATTERNS" ]; then
              # Build regex alternation for efficient filtering (patterns are used as-is)
              EXCLUDE_REGEX=$(echo "$EXCLUDE_PATTERNS" | tr '\n' '|' | sed 's/|$//')
              # Use -- to prevent patterns starting with - from being interpreted as flags
              DIFF_OUTPUT=$(echo "$DIFF_OUTPUT" | grep -vE -- "$EXCLUDE_REGEX" || true)
            fi
          fi

          # Add custom exclude patterns if provided via input
          if [ -n "${{ inputs.exclude-patterns }}" ]; then
            IFS=',' read -ra CUSTOM_PATTERNS <<< "${{ inputs.exclude-patterns }}"
            # Build regex alternation (patterns are used as-is, like .preflight-exclude)
            CUSTOM_REGEX=$(printf "%s|" "${CUSTOM_PATTERNS[@]}" | sed 's/|$//')
            DIFF_OUTPUT=$(echo "$DIFF_OUTPUT" | grep -vE -- "$CUSTOM_REGEX" || true)
          fi

          # Validate that not all files were filtered out
          if [ -n "$RAW_DIFF_OUTPUT" ] && [ -z "$DIFF_OUTPUT" ]; then
            echo "⚠️  Warning: All changed files were excluded by filters"
            echo "This PR contains only lock files, license texts, or other excluded patterns"
            echo "✅ PR size check passed (all changes are auto-generated/excluded)"
            exit 0
          fi

          CHANGED=$(echo "$DIFF_OUTPUT" | awk '{ins+=$1; del+=$2} END {print ins+del+0}')

          echo "Changed lines (after exclusions from .preflight-exclude): $CHANGED"
          echo "Maximum allowed: $MAX_LINES"

          if [ "$CHANGED" -gt "$MAX_LINES" ]; then
            echo "::error::PR too large ($CHANGED > $MAX_LINES lines). Please split into smaller changes."
            echo "Tip: Lock files and license files are excluded via .preflight-exclude"
            echo "For legitimate large PRs (e.g., boilerplate templates), request the 'large-pr-approved' label from a maintainer."
            exit 1
          fi

          echo "✅ PR size is acceptable ($CHANGED <= $MAX_LINES lines)"
