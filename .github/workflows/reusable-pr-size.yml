# SPDX-FileCopyrightText: 2025 SecPal
# SPDX-License-Identifier: CC0-1.0

name: Reusable PR Size Check

on:
  workflow_call:
    inputs:
      max-lines:
        description: "Maximum number of lines allowed in a PR"
        required: false
        type: number
        default: 600
      exclude-patterns:
        description: "Additional file patterns to exclude (comma-separated)"
        required: false
        type: string
        default: ""

jobs:
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check PR size
        env:
          GH_TOKEN: ${{ github.token }}
          MAX_LINES: ${{ inputs.max-lines }}
        run: |
          # Check if PR has 'large-pr-approved' label
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')

          if echo "$LABELS" | grep -q "large-pr-approved"; then
            echo "✅ PR has 'large-pr-approved' label - skipping size check"
            echo "Reason: Legitimate large PR (e.g., boilerplate templates, auto-generated code)"
            exit 0
          fi

          # Fetch base branch
          git fetch origin ${{ github.base_ref }}

          # Calculate merge base
          MERGE_BASE=$(git merge-base origin/${{ github.base_ref }} HEAD)

          # Build exclude patterns
          EXCLUDE_PATTERNS=(
            'package-lock.json'
            'composer.lock'
            'yarn.lock'
            'pnpm-lock.yaml'
            'LICENSES/.*\.txt$'
          )

          # Add custom exclude patterns if provided
          if [ -n "${{ inputs.exclude-patterns }}" ]; then
            IFS=',' read -ra CUSTOM_PATTERNS <<< "${{ inputs.exclude-patterns }}"
            EXCLUDE_PATTERNS+=("${CUSTOM_PATTERNS[@]}")
          fi

          # Count changed lines with exclusions
          DIFF_OUTPUT=$(git diff --numstat "$MERGE_BASE"..HEAD)

          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            DIFF_OUTPUT=$(echo "$DIFF_OUTPUT" | grep -v "$pattern" || true)
          done

          CHANGED=$(echo "$DIFF_OUTPUT" | awk '{ins+=$1; del+=$2} END {print ins+del+0}')

          echo "Changed lines (excluding lock files, license texts, and custom patterns): $CHANGED"
          echo "Maximum allowed: $MAX_LINES"

          if [ "$CHANGED" -gt "$MAX_LINES" ]; then
            echo "::error::PR too large ($CHANGED > $MAX_LINES lines). Please split into smaller changes."
            echo "Tip: Auto-generated files (package-lock.json, composer.lock, etc.) and license texts are excluded from this count."
            echo "For legitimate large PRs (e.g., boilerplate templates), request the 'large-pr-approved' label from a maintainer."
            exit 1
          fi

          echo "✅ PR size is acceptable ($CHANGED <= $MAX_LINES lines)"
