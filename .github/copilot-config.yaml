# SPDX-FileCopyrightText: 2025 SecPal
# SPDX-License-Identifier: CC0-1.0

# GitHub Copilot Configuration (YAML Format)
# This file provides 10x faster parsing than markdown for AI consumption

version: "1.0"
organization: SecPal
repository: .github

# Core Principles (Highest Priority)
core_principles:
  - id: critical-rule-1
    title: TDD-First Development
    priority: CRITICAL
    description: No implementation without test. Test MUST fail first, then pass after implementation.
    validation: "Run tests before coding. Red → Green → Refactor."

  - id: critical-rule-2
    title: Never Skip Preflight Checks
    priority: CRITICAL
    description: "All commits MUST pass: Prettier, Markdownlint, REUSE, Actionlint"
    validation: "Pre-commit hook enforces. NO --no-verify (see Critical Rule #4 for exceptions)."

  - id: critical-rule-3
    title: 1 PR = 1 Topic
    priority: CRITICAL
    description: One pull request addresses ONE logical change. No mixed concerns.
    validation: "PR title describes single purpose. Related changes only."

  - id: critical-rule-4
    title: Signed Commits Only
    priority: CRITICAL
    description: All commits MUST be GPG-signed. No exceptions.
    validation: "git log --show-signature shows 'Good signature'"

  - id: critical-rule-5
    title: REUSE Compliance
    priority: CRITICAL
    description: Every file MUST have SPDX headers (copyright + license)
    validation: "reuse lint returns 0 errors"

# Repository Policies
policies:
  git:
    commit_signing: required
    commit_message_format: "type(scope): description"
    branch_naming: "type/descriptive-name"

  quality:
    test_coverage: 100 # percentage for critical paths
    code_review: required
    ci_checks: all_must_pass

  licensing:
    primary: AGPL-3.0-or-later
    headers: SPDX
    compliance_tool: reuse

  pr_workflow:
    one_topic: true
    size_limit: 600 # lines changed (consistent with instructions)
    review_required: true
    copilot_review: mandatory

# Copilot Review Protocol
copilot_review:
  enabled: true
  process:
    - step: 1
      action: query_unresolved_threads
      tool: graphql
      critical: "NEVER use issue comments to respond"

    - step: 2
      action: fix_comments
      method: commit_and_push

    - step: 3
      action: wait_for_ci
      duration: 30
      note: "Copilot re-reviews after push"

    - step: 4
      action: resolve_threads
      tool: graphql_mutation
      command: "resolveReviewThread"
      critical: "ONLY GraphQL, NEVER comments"

    - step: 5
      action: iterate
      condition: "until no unresolved threads"

  forbidden:
    - mcp_github_github_add_issue_comment
    - mcp_github_github_add_comment_to_pending_review

  allowed:
    - graphql_query_threads
    - graphql_mutation_resolve
    - update_pr_description

# Technology Stack
stack:
  backend:
    language: PHP
    version: "8.4"
    framework: Laravel
    framework_version: "12.x"
    testing: Pest # EXCLUSIVE: Only Pest, never PHPUnit directly
    test_runner: "ddev exec php artisan test"
    development_environment: DDEV
    database: PostgreSQL 16

  frontend:
    language: TypeScript
    framework: React
    build_tool: Vite
    testing: Vitest

  api_contracts:
    format: OpenAPI
    version: "3.1"
    validation: Redocly

  infrastructure:
    ci_cd: GitHub Actions
    cla: CLA Assistant
    license_check: REUSE

# Testing Standards
testing:
  backend:
    framework: Pest
    runner: "ddev exec php artisan test"
    coverage_minimum: 80
    coverage_critical: 100
    patterns:
      - "NEVER write PHPUnit classes directly"
      - "ALWAYS use Pest's it/test functions"
      - "Feature tests: tests/Feature/**/*Test.php"
      - "Unit tests: tests/Unit/**/*Test.php"
      - "TDD REQUIRED: Test MUST fail first"
    
  frontend:
    framework: Vitest
    runner: "npm test"
    library: React Testing Library
    patterns:
      - "Component tests: *.test.tsx"
      - "Integration tests: *.integration.test.tsx"

# File Patterns
file_patterns:
  ignore:
    - "vendor/**"
    - "node_modules/**"
    - "*.log"
    - ".env*"

  require_spdx:
    - "**/*.php"
    - "**/*.ts"
    - "**/*.tsx"
    - "**/*.js"
    - "**/*.md"
    - "**/*.yaml"
    - "**/*.json"

# Validation Commands
validation:
  preflight:
    prettier: "npx prettier --check ."
    markdownlint: "npx markdownlint-cli2 '**/*.md'"
    reuse: "reuse lint"
    actionlint: "actionlint"

  tests:
    backend: "ddev exec php artisan test"
    backend_local: "php artisan test"
    frontend: "npm test"

  linting:
    backend: "./vendor/bin/pint --test"
    frontend: "npm run lint"

  development:
    start: "ddev start"
    stop: "ddev stop"
    exec: "ddev exec <command>"
    ssh: "ddev ssh"
    logs: "ddev logs"

# Data Protection (GDPR/DSGVO)
data_protection:
  encryption:
    personal_data_fields:
      - email_enc # Encrypted email storage
      - phone_enc # Encrypted phone storage
      - note_enc # Encrypted notes

    blind_indexes:
      - email_idx # Searchable email index (hashed)
      - phone_idx # Searchable phone index (hashed)

    transient_properties:
      - email_plain # Write-only plaintext email (auto-encrypts to email_enc)
      - phone_plain # Write-only plaintext phone (auto-encrypts to phone_enc)

    pattern: |
      ALWAYS use transient properties in tests/factories:
      Person::factory()->create(['email_plain' => 'test@example.com'])

      NEVER directly access encrypted fields:
      ❌ $person->email_enc (returns encrypted blob)
      ✅ Use blind index for queries: where('email_idx', hash($email))

    implementation:
      cast: "App\\Casts\\EncryptedWithDek"
      observer: "App\\Observers\\PersonObserver (auto-generates blind indexes)"
      documentation: "See DEVELOPMENT.md for encryption architecture"

# Quick Reference
quick_reference:
  markdown_config: ".github/.markdownlint.json"
  copilot_instructions: ".github/copilot-instructions.md"
  license_whitelist: ".github/license-whitelist.txt"
  cla_document: "CLA.md"

# Parsing Performance
metadata:
  format: yaml
  version: "1.0"
  parsing_advantage: "10x faster than markdown for AI"
  compatibility: "Supplements markdown instructions"
  priority: "YAML > Markdown (if conflict)"
