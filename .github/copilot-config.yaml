# SPDX-FileCopyrightText: 2025 SecPal
# SPDX-License-Identifier: CC0-1.0

# GitHub Copilot Configuration (YAML Format)
# This file provides 10x faster parsing than markdown for AI consumption

version: "1.0"
organization: SecPal
repository: .github

# Multi-Repository Structure
multi_repo:
  description: "SecPal uses multiple repositories with shared base rules and repo-specific overrides"
  structure:
    base: ".github"
    repositories:
      - name: ".github"
        type: "organization-wide"
        description: "Base rules, templates, workflows, governance files"
        copilot_instructions: ".github/copilot-instructions.md"
        config: ".github/copilot-config.yaml"
        override_allowed: false

      - name: "api"
        type: "backend"
        description: "Laravel backend application"
        copilot_instructions: "api/.github/copilot-instructions.md"
        extends: ".github/copilot-config.yaml"
        override_allowed: true
        specific_rules:
          - "DDEV-specific commands (ddev exec)"
          - "Pest testing framework (never PHPUnit directly)"
          - "Data protection (GDPR encryption patterns)"

      - name: "frontend"
        type: "frontend"
        description: "React/TypeScript frontend application"
        copilot_instructions: "frontend/.github/copilot-instructions.md"
        extends: ".github/copilot-config.yaml"
        override_allowed: true
        specific_rules:
          - "React/TypeScript patterns"
          - "Vitest testing framework"
          - "PWA-specific requirements"

      - name: "contracts"
        type: "api-specification"
        description: "OpenAPI 3.1 specifications"
        copilot_instructions: "contracts/.github/copilot-instructions.md"
        extends: ".github/copilot-config.yaml"
        override_allowed: true
        specific_rules:
          - "OpenAPI validation (Redocly)"
          - "Contract-first development"
          - "Must be updated FIRST before api/frontend"

  inheritance_rules:
    priority: "Repository-specific > Organization-wide"
    override_policy: "Repository can override non-critical rules only"
    critical_rules_always_apply:
      - "TDD-First Development"
      - "Never Skip Preflight Checks"
      - "1 PR = 1 Topic"
      - "Signed Commits Only"
      - "REUSE Compliance"
      - "Domain Policy"
      - "Copilot Review Protocol (NEVER comment on reviews)"

  coordination:
    breaking_changes: "Update contracts/ FIRST, then api/ and frontend/ in parallel"
    version_locking: "Tag contracts before implementing in api/frontend"
    new_api_version: "Create /api/v2/ for breaking changes, parallel support"

# Core Principles (Highest Priority)
core_principles:
  - id: critical-rule-1
    title: TDD-First Development
    priority: CRITICAL
    description: No implementation without test. Test MUST fail first, then pass after implementation.
    validation: "Run tests before coding. Red â†’ Green â†’ Refactor."

  - id: critical-rule-2
    title: Never Skip Preflight Checks
    priority: CRITICAL
    description: "All commits MUST pass: Prettier, Markdownlint, REUSE, Actionlint"
    validation: "Pre-commit hook enforces. NO --no-verify (see Critical Rule #4 for exceptions)."

  - id: critical-rule-3
    title: 1 PR = 1 Topic
    priority: CRITICAL
    description: One pull request addresses ONE logical change. No mixed concerns.
    validation: "PR title describes single purpose. Related changes only."

  - id: critical-rule-4
    title: Signed Commits Only
    priority: CRITICAL
    description: All commits MUST be GPG-signed. No exceptions.
    validation: "git log --show-signature shows 'Good signature'"

  - id: critical-rule-5
    title: REUSE Compliance
    priority: CRITICAL
    description: Every file MUST have SPDX headers (copyright + license)
    validation: "reuse lint returns 0 errors"

  - id: critical-rule-6
    title: Issue Management Protocol
    priority: CRITICAL
    description: "IMMEDIATELY create GitHub issue when bug/improvement found that cannot be fixed now. EPIC + sub-issues REQUIRED for all features."
    validation: "All findings documented as GitHub issues. No 'TODO: fix later' without issue link."
    enforcement: "Zero tolerance - saying 'we should fix X' without creating issue = violation"

# Development Principles
development_principles:
  dry:
    title: "Don't Repeat Yourself (DRY)"
    description: "Eliminate code duplication. Extract shared logic into functions/classes/modules."
    validation: "Review code for duplicate patterns. Refactor before committing."
    examples:
      - "Extract common validation logic into reusable functions"
      - "Use inheritance/composition instead of copying methods"
      - "Create shared utilities instead of duplicating across files"

  solid:
    title: "SOLID Principles"
    description: "Object-oriented design principles for maintainable, scalable code"
    principles:
      single_responsibility:
        name: "Single Responsibility Principle (SRP)"
        rule: "One class/function = one reason to change"
        example: "UserService handles user logic, EmailService handles email logic"
      open_closed:
        name: "Open/Closed Principle (OCP)"
        rule: "Open for extension, closed for modification"
        example: "Use interfaces/abstract classes to allow extension without modifying existing code"
      liskov_substitution:
        name: "Liskov Substitution Principle (LSP)"
        rule: "Subtypes must be substitutable for base types"
        example: "Square extends Rectangle but violates LSP if width/height behavior differs"
      interface_segregation:
        name: "Interface Segregation Principle (ISP)"
        rule: "Many small interfaces > one large interface"
        example: "Separate Readable and Writable interfaces instead of combined ReadWrite"
      dependency_inversion:
        name: "Dependency Inversion Principle (DIP)"
        rule: "Depend on abstractions, not concretions"
        example: "Inject interfaces/contracts instead of concrete implementations"

  quality_first:
    title: "Quality Over Speed"
    description: "Take time to implement correctly. Fast but broken code creates technical debt."
    validation: "Execute 4-pass review BEFORE committing"

  communication_language:
    title: "English-Only Communication"
    rule: "All GitHub communication (issues, PRs, comments, documentation) MUST be in English"
    rationale: "Ensures accessibility for international contributors and maintainability"
    exceptions:
      - "German legal documents (CLA, licenses) require bilingual versions"
      - "User-facing German translations in frontend (i18n files)"
    validation: "Review all commit messages, PR descriptions, issue comments for English compliance"

  no_literal_quotes:
    title: "No Literal Code Quotes"
    rule: "Never copy/paste large code blocks verbatim without understanding"
    rationale: "Duplicate code in comments/docs creates maintenance burden and confusion"
    correct_approach: "Reference existing code by file path and line numbers"
    examples:
      correct:
        - "See `src/utils/auth.ts` lines 45-60 for implementation"
        - "Follows pattern from `UserController.php:123`"
      incorrect:
        - "Copying 50 lines of code into PR description"
        - "Pasting entire function into issue comment"

# Repository Policies
policies:
  git:
    commit_signing: required
    commit_message_format: "type(scope): description"
    branch_naming: "type/descriptive-name"

  quality:
    test_coverage: 100 # percentage for critical paths
    code_review: required
    ci_checks: all_must_pass

  licensing:
    primary: AGPL-3.0-or-later
    headers: SPDX
    compliance_tool: reuse

  pr_workflow:
    one_topic: true
    size_limit: 600 # lines changed (consistent with instructions)
    review_required: true
    copilot_review: mandatory

  ai_autonomy:
    critical_analysis_required: true
    description: "AI must critically validate all suggestions and make autonomous decisions when answer is clear"

    copilot_comment_validation:
      rule: "ALWAYS validate Copilot review comments critically before implementing"
      rationale: "Copilot is extremely good but sometimes wrong - validation mandatory"
      process:
        - "Read comment and understand suggestion"
        - "Check against our principles and documented rules"
        - "Validate technical correctness (is this actually a bug?)"
        - "Check context awareness (did Copilot miss project-specific rules?)"
        - "Implement if valid, document rejection reason if invalid"
      examples:
        valid_comment: "Logic bug that would cause incorrect behavior"
        invalid_comment: "Suggests pattern that violates documented project conventions"

# Issue Management Protocol (CRITICAL)
issue_management:
  critical: true
  priority: CRITICAL
  philosophy: "Every problem discovered MUST be tracked. No mental todos, no 'we should fix later' comments."

  immediate_issue_creation:
    rule: "Found bug/issue in old code that cannot be fixed immediately? CREATE GITHUB ISSUE NOW."
    enforcement: "ZERO TOLERANCE - Proceeding without issue creation = Critical Rule violation"
    rationale: "Untracked issues get forgotten. GitHub is single source of truth."

    when_to_create_immediately:
      - "Bug found in old code during current work"
      - "Security vulnerability discovered (use SECURITY.md for responsible disclosure, NOT public issue)"
      - "Technical debt identified"
      - "Missing test coverage found"
      - "Documentation gap discovered"
      - "Performance issue noticed"
      - "Code smell that needs refactoring"
      - "Any finding that cannot be fixed in current PR scope"

    when_not_to_create:
      - "Issue directly related to current PR topic (fix in current PR)"
      - "Typo you can fix in 10 seconds (just fix it)"

    required_issue_fields:
      title: "Clear, descriptive title (50 chars max)"
      description: "Detailed problem description with context"
      reproduction_steps: "How to reproduce (if bug)"
      affected_files: "List of files involved"
      labels: "bug, technical-debt, enhancement, security, etc."
      context: "Link to current PR/branch if found during work"
      priority: "Assess impact: critical, high, medium, low"

    commands:
      create_bug: 'gh issue create --title "Bug: ..." --body "..." --label "bug"'
      create_technical_debt: 'gh issue create --title "Tech Debt: ..." --body "..." --label "technical-debt"'
      create_enhancement: 'gh issue create --title "Enhancement: ..." --body "..." --label "enhancement"'

    examples:
      scenario_1:
        context: "Working on docs, find security bug in auth middleware"
        action: "Create issue IMMEDIATELY: 'Bug: Auth middleware missing rate limiting'"
        reasoning: "Security issue unrelated to docs work â†’ separate issue required"

      scenario_2:
        context: "Implementing feature X, notice test coverage for module Y is 40%"
        action: "Create issue: 'Tech Debt: Increase test coverage for module Y to 80%'"
        reasoning: "Coverage issue unrelated to feature X â†’ track separately"

      scenario_3:
        context: "Refactoring class A, notice similar duplication in class B"
        action: "Fix class A in current PR, create issue for class B"
        reasoning: "Class A = current scope, Class B = separate work"

  epic_and_sub_issues:
    rule: "ALL features requiring >1 PR MUST use EPIC + sub-issues structure"
    enforcement: "MANDATORY - No exceptions for complex features"
    rationale: "Maintains One Topic Rule, enables granular tracking, prevents premature epic closure"

    when_to_use_epic:
      - "Feature requires multiple PRs (>600 lines total)"
      - "Work spans multiple files/modules/repos"
      - "Implementation takes >1 day"
      - "Multiple logical steps with dependencies"
      - "Breaking changes requiring coordination"

    when_not_to_use_epic:
      - "Simple feature fitting in single PR (<600 lines)"
      - "Single bug fix"
      - "Documentation-only changes"

    epic_structure:
      epic_issue:
        template: "Use GitHub template: 'ðŸ—ºï¸ Epic (Multi-PR Feature)'"
        required_sections:
          - "Goal: High-level feature description"
          - "Sub-Issues & Work Plan: Tasklist linking to sub-issues"
          - "Acceptance Criteria: When is epic complete?"
          - "Non-Goals: What's explicitly out of scope?"
          - "Dependencies: Other epics/issues blocking this"
        stays_open: "Epic remains open until ALL sub-issues completed"

      sub_issues:
        template: "Use GitHub template: 'ðŸ“¦ Sub-Issue (Part of Epic)'"
        one_pr_per_sub_issue: "Each sub-issue = exactly 1 PR"
        required_sections:
          - "Link to parent epic: 'Sub-issue of #123'"
          - "Clear, focused goal (one PR's worth ~400-600 LOC)"
          - "Acceptance criteria specific to this sub-issue"
          - "Dependencies: Which sub-issues must complete first?"
        labels: "type/sub-issue, area/*, priority/*"

      pr_linking:
        rule: "Each PR references its sub-issue, NOT the epic"
        format: "Fixes #<sub-issue-number>"
        why: "Prevents premature epic closure, maintains granular tracking"
        example: "PR description: 'Fixes #52' (sub-issue), NOT 'Fixes #50' (epic)"

    commands:
      create_epic: 'gh issue create --template epic.yml --title "[EPIC] Feature name"'
      create_sub_issue: 'gh issue create --template sub-issue.yml --title "PR-X: Step name"'
      list_sub_issues: 'gh issue list --label "type/sub-issue" --json number,title'

    workflow:
      - step: 1
        action: "Create epic issue using template"
        validation: "Epic has goal, acceptance criteria, non-goals"

      - step: 2
        action: "Break down work into logical chunks (~400-600 LOC each)"
        validation: "Each chunk is independently testable and reviewable"

      - step: 3
        action: "Create sub-issue for each chunk"
        validation: "Sub-issue links to parent epic, has clear scope"

      - step: 4
        action: "Update epic tasklist with sub-issue links"
        validation: "GitHub shows progress tracker (X of Y tasks complete)"

      - step: 5
        action: "Work on sub-issues sequentially (or parallel if independent)"
        validation: "One PR per sub-issue, PR references sub-issue not epic"

      - step: 6
        action: "Last sub-issue PR closes the epic"
        validation: "PR description: 'Fixes #<last-sub-issue> and closes #<epic>'"

    documentation_reference:
      detailed_guide: "api/docs/EPIC_WORKFLOW.md"
      real_world_example: "Issue #50 with 7 sub-issues (#52, #53, #55, #60, #64, #65, #67)"

  ai_protocol:
    discovery_workflow:
      - step: 1
        trigger: "AI discovers bug/issue/improvement during work"
        action: "IMMEDIATELY assess: Can fix now or needs separate work?"

      - step: 2
        decision_can_fix_now:
          condition: "Issue directly related to current PR topic AND <50 LOC"
          action: "Fix in current PR, document in commit message"

        decision_needs_separate_work:
          condition: "Issue unrelated OR >50 LOC OR requires testing/research"
          action: "CREATE GITHUB ISSUE IMMEDIATELY - DO NOT PROCEED WITHOUT IT"
          critical: "ZERO TOLERANCE - This is Critical Rule #6"

      - step: 3
        after_issue_creation:
          action: "Continue with original work"
          note: "New issue will be addressed in separate PR"
          documentation: "Mention in current PR description: 'Found issue #123 during work, tracked separately'"

    feature_planning_workflow:
      - step: 1
        trigger: "User requests new feature or AI proposes improvement"
        action: "Assess complexity: Single PR or multiple PRs?"

      - step: 2
        decision_single_pr:
          condition: "Feature fits in <600 lines, single module, <1 day work"
          action: "Create simple issue, proceed with PR"

        decision_epic_needed:
          condition: "Feature needs >600 lines OR multiple modules OR >1 day OR breaking changes"
          action: "STOP - Create EPIC structure FIRST before any code"
          critical: "No coding until EPIC + sub-issues defined"

      - step: 3
        after_epic_creation:
          action: "Start with sub-issue #1, create PR, merge"
          sequence: "Sequential: sub-issue â†’ PR â†’ merge â†’ next sub-issue"
          parallel: "Parallel allowed if sub-issues independent"

    forbidden_patterns:
      - pattern: "Saying 'we should fix X later' without creating issue"
        violation: "Critical Rule #6 - Issue Management Protocol"
        consequence: "Work MUST stop until issue created"

      - pattern: "TODO comments without GitHub issue reference"
        violation: "Untracked work - forbidden"
        fix: "Replace 'TODO: fix X' with 'TODO(#123): fix X' or create issue"

      - pattern: "Complex feature (>600 LOC) without EPIC structure"
        violation: "Critical Rule #6 - EPIC requirement"
        consequence: "Reject PR, require EPIC creation first"

      - pattern: "PR referencing epic instead of sub-issue"
        violation: "Premature epic closure"
        fix: "Change 'Fixes #50' (epic) to 'Fixes #52' (sub-issue)"

    autonomous_decisions:
      rule: "Make decisions autonomously when answer is clear from principles/docs"
      rationale: "Reduces unnecessary back-and-forth, maintains flow"
      when_to_decide_autonomously:
        - "Fix clearly violates documented principle (e.g., DRY, TDD)"
        - "Question answered in copilot-config.yaml or copilot-instructions.md"
        - "Standard workflow documented (e.g., pre-commit checklist)"
        - "Technical correctness is unambiguous (e.g., syntax error, logic bug)"
        - "Security best practice applies (e.g., input validation required)"
      when_to_ask:
        - "Ambiguous requirement or multiple valid interpretations"
        - "User preference needed (e.g., naming convention when both valid)"
        - "Breaking change that affects user workflow"
        - "Architectural decision with trade-offs"
        - "Emergency exception to critical rule"

      examples:
        autonomous:
          - "Copilot suggests fixing logic bug â†’ Fix it (technically correct)"
          - "Pre-commit checklist item failed â†’ Fix before committing (documented rule)"
          - "Code violates DRY principle â†’ Refactor (core principle)"
        ask_user:
          - "Two refactoring approaches possible â†’ Ask which preferred"
          - "Emergency production fix needs bypass â†’ Confirm with user"

# Copilot Review Protocol
copilot_review:
  enabled: true

  # ðŸš¨ CRITICAL RULE - NEVER VIOLATE ðŸš¨
  absolute_prohibition:
    rule: "NEVER RESPOND TO COPILOT REVIEW COMMENTS USING GITHUB COMMENT TOOLS"
    rationale: "Commenting creates unwanted bot PRs and notification spam"
    enforcement: "HARD BLOCK - Any violation requires immediate rollback"
    forbidden_actions:
      - "Adding comments to review threads"
      - "Replying to Copilot suggestions"
      - "Using mcp_github_github_add_issue_comment"
      - "Using mcp_github_github_add_comment_to_pending_review"
      - "Any GitHub UI comment on review threads"

    correct_workflow:
      - "Fix the code based on Copilot comment"
      - "Commit and push the fix"
      - "Wait for Copilot to re-review (30s)"
      - "Resolve thread via GraphQL mutation ONLY"
      - "Update PR description for documentation (NOT comments)"

    why_this_matters: "Copilot re-reviews after each push. Comments trigger bot PRs. Resolution via GraphQL is the ONLY correct method."

  process:
    - step: 1
      action: query_unresolved_threads
      tool: graphql
      command: |
        gh api graphql -f query='query{repository(owner:"SecPal",name:"REPO"){pullRequest(number:N){reviewThreads(first:20){nodes{id isResolved comments(first:1){nodes{path line body}}}}}}' --jq '.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)'
      critical: "NEVER use issue comments to respond"

    - step: 2
      action: fix_comments
      method: commit_and_push
      note: "Fix code, do NOT reply to comment"

    - step: 3
      action: wait_for_ci
      duration: 30
      note: "Copilot re-reviews after push, may add NEW threads"

    - step: 4
      action: resolve_threads
      tool: graphql_mutation
      command: |
        gh api graphql -f query='mutation{resolveReviewThread(input:{threadId:"THREAD_ID"}){thread{id isResolved}}}'
      critical: "ONLY GraphQL mutation, NEVER comments"

    - step: 5
      action: iterate
      condition: "until no unresolved threads"
      note: "Repeat steps 1-4 until query returns empty array"

  forbidden_tools:
    - tool: mcp_github_github_add_issue_comment
      reason: "Creates bot PRs"
      alternative: "GraphQL resolveReviewThread mutation"

    - tool: mcp_github_github_add_comment_to_pending_review
      reason: "Creates unwanted comment threads"
      alternative: "Fix code, push, resolve via GraphQL"

    - tool: "GitHub UI comment"
      reason: "Triggers bot automation"
      alternative: "Update PR description for documentation"

  allowed_tools:
    - graphql_query_threads
    - graphql_mutation_resolve
    - update_pr_description

  documentation_updates:
    rule: "Use PR description for documentation, NEVER comments"
    example: "Update PR description to explain why fix was chosen"
    rationale: "PR description is documentation, comments trigger bots"

# Technology Stack
stack:
  backend:
    language: PHP
    version: "8.4"
    framework: Laravel
    framework_version: "12.x"
    testing: Pest # EXCLUSIVE: Only Pest, never PHPUnit directly
    test_runner: "ddev exec php artisan test"
    development_environment: DDEV
    database: PostgreSQL 16

  frontend:
    language: TypeScript
    framework: React
    build_tool: Vite
    testing: Vitest

  api_contracts:
    format: OpenAPI
    version: "3.1"
    validation: Redocly

  infrastructure:
    ci_cd: GitHub Actions
    cla: CLA Assistant
    license_check: REUSE

# Testing Standards
testing:
  backend:
    framework: Pest
    runner: "ddev exec php artisan test"
    coverage_minimum: 80
    coverage_critical: 100
    patterns:
      - "NEVER write PHPUnit classes directly"
      - "ALWAYS use Pest's test() or it() functions"
      - "Feature tests: tests/Feature/**/*Test.php"
      - "Unit tests: tests/Unit/**/*Test.php"
      - "TDD REQUIRED: Test MUST fail first"

  frontend:
    framework: Vitest
    runner: "npm test"
    library: React Testing Library
    patterns:
      - "Component tests: *.test.tsx"
      - "Integration tests: *.integration.test.tsx"

# File Patterns
file_patterns:
  ignore:
    - "vendor/**"
    - "node_modules/**"
    - "*.log"
    - ".env*"

  require_spdx:
    - "**/*.php"
    - "**/*.ts"
    - "**/*.tsx"
    - "**/*.js"
    - "**/*.md"
    - "**/*.yaml"
    - "**/*.json"

# Validation Commands
validation:
  preflight:
    prettier: "npx prettier --check ."
    markdownlint: "npx markdownlint-cli2 '**/*.md'"
    reuse: "reuse lint"
    actionlint: "actionlint"

  tests:
    backend: "ddev exec php artisan test"
    backend_local: "php artisan test"
    frontend: "npm test"

  linting:
    backend: "./vendor/bin/pint --test"
    frontend: "npm run lint"

  development:
    start: "ddev start"
    stop: "ddev stop"
    exec: "ddev exec <command>"
    ssh: "ddev ssh"
    logs: "ddev logs"
    mailpit: "http://localhost:8026 (DDEV Mailpit UI)"

# Data Protection (GDPR/DSGVO)
data_protection:
  encryption:
    personal_data_fields:
      - email_enc # Encrypted email storage
      - phone_enc # Encrypted phone storage
      - note_enc # Encrypted notes

    blind_indexes:
      - email_idx # Searchable email index (hashed)
      - phone_idx # Searchable phone index (hashed)

    transient_properties:
      - email_plain # Write-only plaintext email (auto-encrypts)
      - phone_plain # Write-only plaintext phone (auto-encrypts)

    rules:
      - "ALWAYS use transient properties (_plain) in tests/factories"
      - "NEVER directly access encrypted fields (_enc)"
      - "Use blind indexes (_idx) for queries with hash('sha256', strtolower($value))"
      - "Observer auto-generates indexes on save"

    implementation:
      cast: "App\\Casts\\EncryptedWithDek"
      observer: "App\\Observers\\PersonObserver"
      documentation: "api/DEVELOPMENT.md"

# Quick Reference
quick_reference:
  markdown_config: ".github/.markdownlint.json"
  copilot_instructions: ".github/copilot-instructions.md"
  license_whitelist: ".github/license-whitelist.txt"
  cla_document: "CLA.md"

# Review Automation (ENFORCE THIS WORKFLOW)
review_automation:
  critical: true
  rule: "ALWAYS execute multiple local review passes BEFORE creating PR"

  mandatory_sequence:
    - step: 1
      name: "Write code/docs"
      description: "Complete the feature/fix/refactoring"

    - step: 2
      name: "4-Pass Local Review #1"
      description: "Execute ALL 4 passes (see checklists.review_passes)"
      required: true
      fix_issues: true

    - step: 3
      name: "Fix all issues found"
      description: "Address ALL findings from review #1"

    - step: 4
      name: "4-Pass Local Review #2"
      description: "Re-execute ALL 4 passes to catch new issues"
      required: true

    - step: 5
      name: "Fix remaining issues"
      description: "Address findings from review #2"

    - step: 6
      name: "Optional: 4-Pass Local Review #3+"
      description: "Continue until ZERO issues found"
      when: "Complex changes, multi-file refactoring, > 200 lines"

    - step: 7
      name: "Commit and push"
      description: "ONLY after local reviews find ZERO issues"

    - step: 8
      name: "Create PR as DRAFT"
      description: "gh pr create --draft (Copilot does NOT review drafts)"
      critical: true
      why: "Draft status prevents premature Copilot review"

    - step: 9
      name: "Final self-review in PR view"
      description: "Review diff in GitHub UI, check description completeness"
      when: "Always - UI shows things CLI doesn't"

    - step: 10
      name: "Mark PR as ready (removes draft)"
      description: "gh pr ready - ONLY when local reviews find ZERO issues"
      critical: true
      conditions:
        - "Multiple local 4-pass reviews completed"
        - "ALL local reviews found ZERO issues"
        - "Final self-review in GitHub UI complete"
        - "100% confident Copilot will find ZERO issues"
      triggers: "Copilot review starts NOW (automatic after draft removal)"
      expectation: "If Copilot finds issues â†’ local review process failed"

    - step: 11
      name: "Wait for Copilot review"
      description: "Wait until Copilot review completes (check PR for comments)"
      duration: "Usually 1-3 minutes after marking ready"

    - step: 12
      name: "Query ALL review comments"
      description: "Get complete list via API, don't update PR yet"

    - step: 13
      name: "Critically analyze ALL comments"
      description: "Validate each against principles, technical correctness, context"

    - step: 14
      name: "Fix valid issues in ONE commit"
      description: "Address all valid findings together"

    - step: 15
      name: "Update PR description"
      description: "Document review analysis and decisions"

  draft_pr_workflow:
    create_command: "gh pr create --draft --title '...' --body '...'"
    mark_ready_command: "gh pr ready"
    why_draft_first:
      - "Prevents premature Copilot review"
      - "Allows final self-review in GitHub UI"
      - "Copilot only reviews non-draft PRs"
      - "Can fix issues found in UI review before external review"
      - "Integrates with project automation script"
    when_to_mark_ready:
      - "ONLY when multiple local reviews find ZERO issues"
      - "After final self-review in GitHub UI complete"
      - "When 100% confident Copilot will find ZERO issues"
      - "NEVER mark ready if any uncertainty remains"
    expectation: "Copilot finds ZERO issues = local review process succeeded"

  issue_management_note:
    reference: "See top-level 'issue_management' section for complete protocol (Critical Rule #6)"
    key_rules:
      - "Found bug in old code? CREATE GITHUB ISSUE IMMEDIATELY"
      - "All features >1 PR? Use EPIC + sub-issues structure"
      - "During review: Unrelated issue â†’ create separate issue, maintain One Topic Rule"

  why_multiple_reviews:
    - "First review finds obvious issues"
    - "Second review finds issues introduced by fixes"
    - "Third review catches DRY violations in fix code"
    - "Each pass has different focus (standards, domain, best practices, security)"
    - "Human reviewers (Copilot, teammates) should find ZERO issues"

  anti_patterns:
    - "Commit without local review"
    - "Single-pass review only"
    - "Create PR as ready (not draft) immediately"
    - "Mark draft ready before final self-review"
    - "Update PR description before all Copilot comments received"
    - "Fix issues one-by-one with multiple commits"
    - "Skip reviews because 'it's just docs'"

  enforcement:
    rule: "AI MUST execute minimum 2x 4-pass reviews before creating PR"
    pr_rule: "AI MUST create PR as DRAFT first, mark ready ONLY after final self-review"
    validation: "If external reviewer finds issues â†’ process failed"
    learning: "Each external finding = lesson to improve local review process"

# Enforcement Mechanisms (Technical Controls)
enforcement_mechanisms:
  critical: true
  philosophy: "Automate what can be automated, document what cannot"

  automated_enforcement:
    git_hooks:
      pre_commit:
        script: ".git/hooks/pre-commit"
        enforces:
          - "REUSE compliance"
          - "No secrets in code"
        bypass: "git commit --no-verify (FORBIDDEN except large PR)"

      pre_push:
        script: ".git/hooks/pre-push"
        runs: "./scripts/preflight.sh"
        enforces:
          - "Prettier formatting"
          - "Linting (markdownlint, ESLint, PHPStan)"
          - "Tests pass"
          - "REUSE compliance"
          - "PR size limit (with override)"
          - "Domain policy (IMPLEMENTED in this PR)"
        bypass: "git push --no-verify (FORBIDDEN)"
        exit_code: "Non-zero = push blocked"

    github_actions:
      required_checks:
        - name: "Prettier"
          workflow: "reusable-prettier.yml"
          blocks_merge: true

        - name: "Markdownlint"
          workflow: "reusable-markdown-lint.yml"
          blocks_merge: true

        - name: "REUSE"
          workflow: "reusable-reuse.yml"
          blocks_merge: true

        - name: "PR Size"
          workflow: "reusable-pr-size.yml"
          blocks_merge: true
          can_override: ".preflight-allow-large-pr file"

        - name: "Tests"
          workflow: "reusable-*-test.yml (per repo)"
          blocks_merge: true

      recommended_additions:
        - name: "Domain Policy Check"
          description: "Validate only secpal.app/secpal.dev used"
          script: "./scripts/check-domains.sh (IMPLEMENTED in this PR)"
          blocks_merge: true

        - name: "Draft Enforcement"
          description: "Validate PR created as draft first"
          script: "Check PR timeline via API"
          blocks_merge: false
          action: "Warning only"

        - name: "Commit Convention"
          description: "Validate type(scope): format"
          existing: "commitlint or semantic-pr-title"
          blocks_merge: true

    branch_protection:
      required_settings:
        - setting: "Require pull request before merging"
          value: true
          enforces: "No direct pushes to main"

        - setting: "Require approvals"
          value: 1
          enforces: "Human review required"

        - setting: "Require status checks to pass"
          value: true
          enforces: "All CI checks must be green"

        - setting: "Require conversation resolution"
          value: true
          enforces: "All review comments addressed"

        - setting: "Require signed commits"
          value: true
          enforces: "GPG signature on all commits"

        - setting: "Do not allow bypassing the above settings"
          value: true
          enforces: "No admin override"

        - setting: "Require linear history"
          value: true
          enforces: "Squash merge only"

  semi_automated:
    scriptable_validations:
      - name: "Domain Policy Check"
        script_path: "./scripts/check-domains.sh"
        command: 'grep -r "secpal\." --include="*.md" --include="*.yaml" --include="*.json" --include="*.sh" | grep -v "secpal\.app\|secpal\.dev"'
        expected_output: "Empty (no matches)"
        integration: "Integrated in preflight.sh (this PR)"
        exit_on_failure: true

      - name: "One Topic Heuristic"
        script_path: "./scripts/check-one-topic.sh"
        logic: "Parse commit messages, detect mixed types (feat+fix, refactor+feature)"
        accuracy: "Heuristic only, not 100% reliable"
        integration: "Add to preflight.sh as warning"
        exit_on_failure: false

      - name: "Pre-PR Checklist"
        script_path: "./scripts/pre-pr-checklist.sh"
        type: "Interactive"
        prompts:
          - "Did you execute 2+ full 4-pass reviews? (y/n)"
          - "Did all reviews find ZERO issues? (y/n)"
          - "Is PR description complete? (y/n)"
          - "Ready to create PR as DRAFT? (y/n)"
        integration: "Manual execution before gh pr create"

  not_automatable:
    human_judgment_required:
      - rule: "Multiple 4-pass reviews executed"
        why: "Cannot verify AI internal review process"
        enforcement: "Trust + verify via results (Copilot finds zero)"

      - rule: "Issues created for unrelated findings"
        why: "Cannot detect 'relatedness' automatically"
        enforcement: "Human review in PR"

      - rule: "EPIC/sub-issue structure"
        why: "Requires understanding of problem domain"
        enforcement: "Human project management"

      - rule: "Critical thinking on Copilot comments"
        why: "Requires context awareness and judgment"
        enforcement: "Document analysis in PR description"

  implementation_priority:
    phase_1_immediate_completed:
      - "âœ… Add domain policy check to preflight.sh (completed in this PR)"
      - "âœ… Create check-domains.sh script (completed in this PR)"

    phase_1_immediate:
      - "Document branch protection settings"

    phase_2_next:
      - "Add commit convention check (commitlint)"
      - "Create pre-pr-checklist.sh (interactive)"
      - "Add one-topic heuristic (warning only)"

    phase_3_optional:
      - "Draft enforcement GitHub Action"
      - "PR timeline analyzer"
      - "Automated issue creation for findings"

# Checklists (Single Source of Truth)
checklists:
  pre_commit:
    description: "Execute before EVERY commit. NO EXCEPTIONS."
    checks:
      - id: tdd-compliance
        title: TDD Compliance
        items:
          - "Tests written FIRST (failing)"
          - "Implementation added"
          - "Tests now pass"
          - "Coverage â‰¥80% for new code"
          - "Coverage 100% for critical paths"
        validation: "Run test suite and check coverage"

      - id: dry-principle
        title: DRY Principle
        items:
          - "No duplicated logic"
          - "Common code extracted to helpers/utils"
          - "Configuration in config files (not hardcoded)"
        validation: "Code review for duplication"

      - id: solid-principles
        title: SOLID Principles
        items:
          - "Single Responsibility: One class/function = one reason to change"
          - "Open/Closed: Open for extension, closed for modification"
          - "Liskov Substitution: Subtypes substitutable for base types"
          - "Interface Segregation: Many small interfaces > one large"
          - "Dependency Inversion: Depend on abstractions, not concretions"
        validation: "Code review for SOLID compliance"

      - id: quality-over-speed
        title: Quality Over Speed
        items:
          - "Code reviewed by myself (4-pass review)"
          - "All edge cases considered"
          - "Error handling complete"
          - "No shortcuts taken"
        validation: "Self-review checklist completed"

      - id: english-only
        title: English Only Communication
        items:
          - "All commit messages in English"
          - "All PR titles/descriptions in English"
          - "All code comments in English"
          - "All documentation in English (except legal docs and i18n)"
        validation: "Manual review of commit/PR/comments"

      - id: no-literal-quotes
        title: No Literal Quotes
        items:
          - "No large code blocks copy/pasted into comments"
          - "Code references use path/line format (e.g., 'See src/file.ts:45-60')"
          - "Duplicated code in docs creates maintenance burden"
        validation: "Review PR description and comments for verbatim code"

      - id: changelog-updated
        title: CHANGELOG Updated
        items:
          - "Entry added to appropriate section"
          - "Category correct (Added/Changed/Fixed/etc.)"
          - "Migration guide if breaking change"
        validation: "CHANGELOG.md modified in commit"

      - id: documentation-complete
        title: Documentation Complete
        items:
          - "Public APIs have JSDoc/PHPDoc/TSDoc"
          - "Complex functions have examples"
          - "README updated if needed"
        validation: "Documentation review"

      - id: preflight-script
        title: Preflight Script
        items:
          - "./scripts/preflight.sh executed"
          - "Exit code 0 (all checks pass)"
          - "If fails: FIX, don't bypass"
        validation: "./scripts/preflight.sh"

      - id: no-bypass
        title: No Bypass Used
        items:
          - "No --no-verify flag"
          - "Exception: Large PR with large-pr-approved label only"
        validation: "Git history check"

      - id: issue-creation
        title: Issue Creation Protocol
        items:
          - "All discovered bugs/improvements have GitHub issues?"
          - "No 'TODO: fix later' comments without issue reference?"
          - "Complex features (>1 PR) have EPIC + sub-issues structure?"
          - "All unrelated findings documented as separate issues?"
        validation: "Check for TODO comments, assess complexity vs issue tracking"
        critical: "Critical Rule #6 - Issue Management Protocol"

  review_passes:
    description: "4-Pass Review Strategy - Execute ALL before PR creation"
    passes:
      - id: pass-1
        name: Comprehensive Review
        focus: "Coding standards and completeness"
        checks:
          - "All files use correct coding standards (Prettier, Pint, ESLint)"
          - "All functions documented (JSDoc/PHPDoc/TSDoc with examples)"
          - "All tests present and passing"
          - "No TODOs, FIXMEs, or placeholder comments"
          - "No commented-out code"
          - "No console.log/var_dump debugging statements"

      - id: pass-2
        name: Deep Dive Review
        focus: "Domain and security compliance"
        checks:
          - "Domain compliance: All URLs use secpal.app or secpal.dev"
          - "All email addresses use @secpal.app (NO exceptions)"
          - "Licenses correct (check SPDX headers with reuse lint)"
          - "Security patterns present (input validation, error handling, auth)"
          - "No hardcoded secrets or credentials"
          - "No SQL injection vulnerabilities (parameterized queries only)"
        validation: 'grep -r "secpal\." --include="*.md" --include="*.yaml" --include="*.json"'

      - id: pass-3
        name: Best Practices Review
        focus: "Project infrastructure"
        checks:
          - "Hidden files present: .editorconfig, .gitattributes, .gitignore"
          - "Governance files present: CONTRIBUTING.md, SECURITY.md, CODE_OF_CONDUCT.md, CODEOWNERS"
          - "package.json complete: name, version, description, homepage, bugs, repository, license, author"
          - "OpenAPI spec complete: components, schemas, responses, examples, securitySchemes"
        validation: "ls -la | grep '^\\.'"

      - id: pass-4
        name: Security Auditor Review
        focus: "Security hardening"
        checks:
          - "Workflow permissions explicit and minimal (contents: read)"
          - ".gitignore includes: .env*, *.key, *.pem, secrets/, credentials/"
          - "No secrets in code (API keys, passwords, tokens)"
          - "Pre-push hook configured (./scripts/preflight.sh)"
          - "SECURITY.md contact information correct"
        validation: 'grep -L "^permissions:" .github/workflows/*.yml must return empty'

  post_merge_cleanup:
    description: "Execute IMMEDIATELY after EVERY merge"
    mandatory: true
    steps:
      - step: 1
        command: "git checkout main"
        description: "Switch to main branch"

      - step: 2
        command: "git pull"
        description: "Pull latest changes"

      - step: 3
        command: "git branch -d <feature-branch-name>"
        description: "Delete local feature branch"

      - step: 4
        command: "git fetch --prune"
        description: "Prune remote-tracking branches"

      - step: 5
        command: "git status"
        description: "Verify clean state"
        expected_output: "nothing to commit, working tree clean"

  validation:
    description: "General validation checklist before completing any task"
    checks:
      - "All Critical Rules followed? (TDD, One Topic, No Bypass, CHANGELOG)"
      - "Preflight script would pass? (formatting, linting, tests, REUSE)"
      - "CHANGELOG.md updated? (if feature/fix/breaking change)"
      - "Tests added/updated? (80% coverage minimum)"
      - "Documentation updated? (if public API changed)"
      - "Correct repository context? (api/ vs frontend/ vs contracts/)"
      - "Multi-repo coordination needed? (contracts first?)"
      - "Breaking change? (MAJOR version bump, deprecation process)"
      - "Security implications? (use SECURITY.md process if needed)"
      - "Commit convention followed? (type(scope): description)"
      - "4-Pass Review completed? (all passes documented)"

  copilot_proof_standard:
    description: "Quality target: No AI reviewer can suggest ANY improvements"
    target: "GitHub Copilot review returns ZERO suggestions"
    checks:
      - "All automated checks GREEN (REUSE, Prettier, linting, tests)"
      - "Zero placeholder comments (TODO, FIXME, XXX) - all resolved before PR"
      - "Zero commented-out code blocks"
      - "No console.log / var_dump debugging statements"
      - "No hardcoded values that should be config"
      - "All functions documented (PHPDoc/JSDoc/TSDoc)"
      - "All edge cases tested"
      - "All error paths covered"
      - "No magic numbers without explanation"
      - "No violations of SOLID/DRY principles"
    validation: "Request GitHub Copilot review - ZERO suggestions = standard achieved"

# Workflow Mapping (When to use which checklist)
workflows:
  before_commit:
    description: "Mandatory checks before git commit"
    checklists: ["pre_commit"]
    mandatory: true

  before_pr:
    description: "Mandatory checks before creating pull request"
    checklists: ["pre_commit", "review_passes", "copilot_proof_standard"]
    mandatory: true
    sequence: true # Execute in order

  before_merge:
    description: "Mandatory checks before merging pull request"
    checklists: ["copilot_proof_standard", "validation"]
    mandatory: true

  after_merge:
    description: "Mandatory cleanup after merge"
    checklists: ["post_merge_cleanup"]
    mandatory: true
    immediate: true # Execute IMMEDIATELY, no delay

# Domain Policy (ZERO TOLERANCE)
domain_policy:
  critical: true
  production_domain: "secpal.app"
  development_domain: "secpal.dev"
  email_domain: "secpal.app" # ALL emails use this, including dev

  # Use Case Rules
  use_cases:
    secpal_app:
      - "Production services and APIs"
      - "Real user-facing endpoints"
      - "Email addresses (ALL, including dev/test)"
      - "Official contact information"
      - "Production documentation references"
    secpal_dev:
      - "Development/staging infrastructure"
      - "Testing endpoints"
      - "Code examples and tutorials"
      - "OpenAPI specification examples"
      - "Documentation examples (non-production)"

  forbidden_domains:
    - "secpal.com"
    - "secpal.org"
    - "secpal.net"
    - "secpal.io"
    - "secpal.example" # Even in examples - use secpal.dev instead
  validation_command: 'grep -r "secpal\." --include="*.md" --include="*.yaml" --include="*.json" --include="*.sh"'
  validation_rule: "Command MUST return ONLY secpal.app and secpal.dev"
  enforcement: "Any other match = PR rejected"

# Bot PR Validation
bot_pr_validation:
  critical: true
  scope: "Validate against tech stack and existing fixes"
  auto_reject_criteria:
    - "Technology not in project stack (e.g., Rust when no Rust used)"
    - "Duplicate fix already merged in main"
    - "Language-specific config for unused language"
  validation_process:
    - "Check PR branch name: copilot/sub-pr-* = bot-created"
    - "Validate against current tech stack + merged PRs"
    - "If redundant/irrelevant: Close with explanation"
    - "If valid: Review like human PR (full checklist)"
  tech_stack_check_examples:
    - 'Rust: find . -name "Cargo.toml" | wc -l must be > 0'
    - 'Node.js: find . -name "package.json" | wc -l must be > 0'
    - 'PHP/Laravel: find . -name "composer.json" | wc -l must be > 0'
    - 'Python: find . -name "requirements.txt" -o -name "pyproject.toml" | wc -l must be > 0'

# Learned Lessons (Copilot-Proof Policies)
learned_lessons:
  governance_file_sync:
    issue: "Symlinks don't render on GitHub.com web interface"
    solution: "Copy files from .github/ to other repos"
    files:
      - CONTRIBUTING.md
      - SECURITY.md
      - CODE_OF_CONDUCT.md
      - CODEOWNERS
      - .editorconfig
      - .gitattributes
      - scripts/check-domains.sh
    automation: "./scripts/sync-governance.sh"
    validation: "Script checks file existence and content match"

  security_by_default:
    rule: "Security MUST be explicit from line 1, not added later"
    workflow_permissions: "Explicit minimal permissions required (contents: read)"
    gitignore_required:
      - ".env*"
      - "*.key"
      - "*.pem"
      - "secrets/"
      - "credentials/"
      - "*.secret"
    validation: 'grep -L "^permissions:" .github/workflows/*.yml must be empty'

  hidden_files_priority:
    rule: "Hidden files (.editorconfig, .gitattributes, .gitignore, CODEOWNERS) are EQUALLY critical"
    required_files:
      - .editorconfig
      - .gitattributes
      - .gitignore
      - CODEOWNERS
    validation: 'ls -la | grep "^\\\\." must show all 4 files'

# Parsing Performance
metadata:
  format: yaml
  version: "1.0"
  parsing_advantage: "10x faster than markdown for AI"
  compatibility: "Supplements markdown instructions"
  priority: "YAML > Markdown (if conflict)"
